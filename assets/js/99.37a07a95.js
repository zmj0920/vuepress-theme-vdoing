(window.webpackJsonp=window.webpackJsonp||[]).push([[99],{420:function(s,e,n){"use strict";n.r(e);var a=n(3),t=Object(a.a)({},(function(){var s=this,e=s._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("p",[e("a",{attrs:{href:"https://www.cnblogs.com/xiaoyuanqujing/articles/11838822.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("02-04 keystone部署及操作"),e("OutboundLink")],1)]),s._v(" "),e("p",[s._v("##一 前言")]),s._v(" "),e("p",[s._v("任何软件的部署都是没有技术含量的，任何就部署讲部署的人都是江湖骗子。")]),s._v(" "),e("p",[s._v("部署的本质就是拷贝，粘贴，回车。我们家养了条狗，它可以胜任这件事情。")]),s._v(" "),e("p",[s._v("我们搞技术的，一定不能迂腐：轻信或者一概不信。")]),s._v(" "),e("p",[s._v("轻信者的傻逼就像是只学了上半册的葵花宝典，上半册教你欲练此功必先自宫，而下半册说的则是不自宫其实也可以。")]),s._v(" "),e("p",[s._v("不信者的傻逼就像是马冬什么？马什么梅？什么冬梅？")]),s._v(" "),e("h2",{attrs:{id:"二-版本信息"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#二-版本信息"}},[s._v("#")]),s._v(" 二 版本信息")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/zmj0920/image_store/blog/1036857-20170110162610416-1828217014.png",alt:""}})]),s._v(" "),e("p",[s._v("官网http://docs.openstack.org/newton/install-guide-rdo/keystone.html")]),s._v(" "),e("p",[s._v("我们按照Newton这个版本来部署，其实跟大家讲，openstack基本保持每6个月更新一个版本，面对如此快的版本更迭，我们其实瞅准了一个版本深入研究下去就好，深入到什么层次，为社区提交代码。任何每来一个新版本就去部署一次的主都是傻叉。")]),s._v(" "),e("h2",{attrs:{id:"三-部署keystone"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#三-部署keystone"}},[s._v("#")]),s._v(" 三 部署keystone")]),s._v(" "),e("p",[s._v("参考官网"),e("a",{attrs:{href:"http://docs.openstack.org/newton/install-guide-rdo/",target:"_blank",rel:"noopener noreferrer"}},[s._v("http://docs.openstack.org/newton/install-guide-rdo/"),e("OutboundLink")],1)]),s._v(" "),e("p",[s._v("系统信息")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("[root@localhost ~]# cat /etc/redhat-release\nCentOS Linux release 7.0.1406 (Core)\n[root@localhost ~]# uname -r\n3.10.0-123.el7.x86_64\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[e("strong",[s._v("step 1：准备阶段")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("yum -y install centos-release-openstack-newton #安装官方yum源\nyum -y upgrade #更新\nyum -y install python-openstackclient #安装工具\nyum -y install openstack-selinux #安装openstack-selinux包自动管理openstack组件的安全策略\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[e("strong",[s._v("step 2：部署mariadb")])]),s._v(" "),e("p",[s._v("安装")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("keystone支持ldap和mysql作为后端Driver,用来存放用户相关信息，catalog等，这里我们选用mariadb\nyum -y install mariadb mariadb-server python2-PyMySQL\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("配置：/etc/my.cnf.d/openstack.cnf")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("[mysqld]\nbind-address = 192.168.31.57 #本机管理网络ip\n\ndefault-storage-engine = innodb\ninnodb_file_per_table\nmax_connections = 4096\ncollation-server = utf8_general_ci\ncharacter-set-server = utf8\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("p",[s._v("启动服务且设置开机启动")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("systemctl start mariadb.service\nsystemctl enable mariadb.service\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("初始化数据库（可有可无）")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("mysql_secure_installation\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[e("strong",[s._v("step 3：部署keystone")])]),s._v(" "),e("p",[s._v("keystone关于数据库的操作")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("mysql -u root -p #登入数据库\nCREATE DATABASE keystone; #新建库keystone\nGRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'localhost' \\\n  IDENTIFIED BY '123'; #新建本地访问keystone库的账号\nGRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'%' \\\n  IDENTIFIED BY '123'; #新建远程访问keystone库的账号\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("安装软件包")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("#keystone软件包名openstack-keystone\n#安装httpd和mod_wsgi的原因是，社区主推apache+keystone\n#openstack-keystone本质就是一款基于wsgi协议的web app,而httpd本质就是一个兼容wsgi协议的web server，所以我们需要为httpd安装mod_wsgi模块\nyum -y install openstack-keystone httpd mod_wsgi\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[s._v("配置：/etc/keystone/keystone.conf")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("#让openstack-keystone能够知道如何连接到后端的数据库keystone\n#mysql+pymysql：pymysql是一个python库，使用python可以操作mysql原生sql\n[database]\nconnection = mysql+pymysql://keystone:123@192.168.31.57/keystone\n[token]\nprovider = fernet #fernet为生成token的方式\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("初始化数据库keystone")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('#之所以要初始化，是因为python的orm对象关系映射，需要初始化来生成数据库表结构\nsu -s /bin/sh -c "keystone-manage db_sync" keystone\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("初始化的时候可能会报错")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/zmj0920/image_store/blog/1036857-20170110181152431-1994841330.png",alt:""}})]),s._v(" "),e("p",[s._v("瞬间蒙蔽：我命名建立的用户，啥啥的都能访问啊")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/zmj0920/image_store/blog/1036857-20170110181346400-132306407.png",alt:""}})]),s._v(" "),e("p",[s._v("初始化Fernet key仓库")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("keystone-manage fernet_setup --keystone-user keystone --keystone-group keystone\nkeystone-manage credential_setup --keystone-user keystone --keystone-group keystone\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[e("strong",[s._v("step 4：配置web server整合keystone")])]),s._v(" "),e("p",[s._v("修改本机主机名")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("hostnamectl set-hostname controller\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("配置/etc/hosts")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("192.168.31.57 controller\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("配置/etc/httpd/conf/httpd.conf")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("ServerName controller\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("为mod_wsgi模块添加配置文件")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("#直接拷贝模块文件或者做软连接都可以\nln -s /usr/share/keystone/wsgi-keystone.conf /etc/httpd/conf.d/\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("启动httpd服务且设置开机自启")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("systemctl start httpd.service\nsystemctl enable httpd.service\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("h2",{attrs:{id:"四-keystone操作"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#四-keystone操作"}},[s._v("#")]),s._v(" 四 keystone操作")]),s._v(" "),e("p",[e("strong",[s._v("part 1：创建keystone的catalog")])]),s._v(" "),e("p",[s._v("配置/etc/keystone/keystone.conf")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("[DEFAULT]\nadmin_token = 123\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("设置环境变量")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("#OS_TOKEN=配置文件中的admin_token\n#会在filter过滤过程中被admin_token_auth中间间设置is_admin=True\n#谁有这个admin_token谁就是管理员了。\n\nexport OS_TOKEN=123 #等于keystone.conf中admin_token的值\nexport OS_URL=http://192.168.31.57:35357/v3\nexport OS_IDENTITY_API_VERSION=3\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[s._v("为keystone创建catalog")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('#基于上一步给的权限，创建认证服务实体\nopenstack service create \\\n  --name keystone --description "OpenStack Identity" identity\n\n#基于上一步建立的服务实体，创建访问该实体的三个api端点\nopenstack endpoint create --region RegionOne \\\n  identity public http://192.168.31.57:5000/v3\n\nopenstack endpoint create --region RegionOne \\\n  identity internal http://192.168.31.57:5000/v3\n\nopenstack endpoint create --region RegionOne \\\n  identity admin http://192.168.31.57:35357/v3\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br")])]),e("p",[s._v("****part 2：****创建域，租户，用户，角色，把四个元素关联到一起")]),s._v(" "),e("p",[s._v("The Identity service provides authentication services for each OpenStack service. The authentication service uses a combination of "),e("a",{attrs:{href:"http://docs.openstack.org/newton/install-guide-rdo/common/glossary.html#term-domain",target:"_blank",rel:"noopener noreferrer"}},[s._v("domains"),e("OutboundLink")],1),s._v(", "),e("a",{attrs:{href:"http://docs.openstack.org/newton/install-guide-rdo/common/glossary.html#term-project",target:"_blank",rel:"noopener noreferrer"}},[s._v("projects"),e("OutboundLink")],1),s._v(", "),e("a",{attrs:{href:"http://docs.openstack.org/newton/install-guide-rdo/common/glossary.html#term-user",target:"_blank",rel:"noopener noreferrer"}},[s._v("users"),e("OutboundLink")],1),s._v(", and "),e("a",{attrs:{href:"http://docs.openstack.org/newton/install-guide-rdo/common/glossary.html#term-role",target:"_blank",rel:"noopener noreferrer"}},[s._v("roles"),e("OutboundLink")],1),s._v(".")]),s._v(" "),e("p",[s._v("建立一个公共的域名：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('openstack domain create --description "Default Domain" default\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("创建管理员信息：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('#创建admin项目\nopenstack project create --domain default \\\n  --description "Admin Project" admin\n#创建admin用户\nopenstack user create --domain default \\\n  --password-prompt admin\n#创建admin角色\nopenstack role create admin\n#创建上述三者的关联\nopenstack role add --project admin --user admin admin\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("p",[e("strong",[s._v("part 3：使用Bootstrap完成part1和part2二者的工作")])]),s._v(" "),e("p",[s._v("Bootstrap the Identity service：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("#本质就是在为keystone创建catalog\nkeystone-manage bootstrap --bootstrap-password 123 \\\n  --bootstrap-admin-url http://192.168.31.57:35357/v3/ \\\n  --bootstrap-internal-url http://192.168.31.57:35357/v3/ \\\n  --bootstrap-public-url http://192.168.31.57:5000/v3/ \\\n  --bootstrap-region-id RegionOne\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("设置环境变量（is_admin不会被设置成True，admin用户会获得一个Token）")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("export OS_USERNAME=admin\nexport OS_PASSWORD=123 #就是keystone-manage中设定的--bootstrap-password\nexport OS_PROJECT_NAME=admin\nexport OS_USER_DOMAIN_NAME=Default\nexport OS_PROJECT_DOMAIN_NAME=Default\nexport OS_AUTH_URL=http://192.168.31.57:35357/v3\nexport OS_IDENTITY_API_VERSION=3\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/zmj0920/image_store/blog/1036857-20170110215136900-986259059.png",alt:""}})]),s._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/zmj0920/image_store/blog/1036857-20170110215643900-1148446304.png",alt:""}})]),s._v(" "),e("p",[e("strong",[s._v("part 4：创建用于后期测试用的项目，用户，租户，建立关联")])]),s._v(" "),e("p",[s._v("创建project名为demo")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('openstack project create --domain default \\\n  --description "Demo Project" demo\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("创建普通用户demo")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("openstack user create --domain default \\\n  --password-prompt demo\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("创建普通用户的角色即user")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("openstack role create user\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("建立关联")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("openstack role add --project demo --user demo user\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[e("strong",[s._v("part 5：为后续的服务创建统一租户service")])]),s._v(" "),e("p",[s._v("解释：后面每搭建一个新的服务都需要在keystone中执行四种操作：1.建项目 2.建用户 3.建角色 4.做关联")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('#后面所有的服务公用一个项目service，都是管理员角色admin\n#所以实际上后续的服务安装关于keysotne的操作只剩2，4\nopenstack project create --domain default \\\n  --description "Service Project" service\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("h2",{attrs:{id:"五-验证"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#五-验证"}},[s._v("#")]),s._v(" 五 验证")]),s._v(" "),e("p",[e("strong",[s._v("part 1：准备")])]),s._v(" "),e("p",[s._v("出于安全考虑，需要关闭临时令牌认证机制（配置文件中的admin_token和keystone-manage的--bootstrap-password都是基于该机制）")]),s._v(" "),e("p",[s._v("该机制会将用户的请求设置is_admin=True，源码分析中会介绍，先暂且理解到这里")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("编辑/etc/keystone/keystone-paste.ini\n将\n[pipeline:public_api]\n[pipeline:admin_api]\n[pipeline:api_v3]\n中的admin_token_auth都去掉\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("取消一切设置的环境变量，如")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("unset OS_AUTH_URL OS_PASSWORD\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[e("strong",[s._v("part 2：验证操作方法一")])]),s._v(" "),e("p",[s._v("管理员用户admin申请token")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("openstack --os-auth-url http://controller:35357/v3 \\\n--os-identity-api-version 3  \\\n--os-project-domain-name default \\\n--os-user-domain-name default   \\\n--os-project-name admin \\\n--os-username admin \\\ntoken issue\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/zmj0920/image_store/blog/1036857-20170110230616838-1801322419.png",alt:""}})]),s._v(" "),e("p",[s._v("注意：一定要加上--os-identity-api-version 3")]),s._v(" "),e("p",[s._v("普通用户demo申请token")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("openstack --os-auth-url http://controller:5000/v3 \\\n--os-identity-api-version 3  \\\n--os-project-domain-name default \\\n--os-user-domain-name default   \\\n--os-project-name demo \\\n--os-username demo \\\ntoken issue\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/zmj0920/image_store/blog/1036857-20170110230858853-513698000.png",alt:""}})]),s._v(" "),e("p",[e("strong",[s._v("part 3：验证操作方法二")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('curl -i \\\n-H "Content-Type: application/json" \\\n-d \'\n{\n    "auth": {\n        "identity": {\n            "methods": [\n                "password"\n            ],\n            "password": {\n                "user": {\n                    "domain":{\n                        "name": "default"\n                     },\n                    "name": "admin",\n                    "password": "123"\n                }\n            }\n         },\n         "scope": {\n            "project": {\n                "domain": {\n                        "name":"default"\n                },\n               "name": "admin"\n            }\n         }\n     }\n}\' \\\nhttp://127.0.0.1:5000/v3/auth/tokens\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br")])]),e("h2",{attrs:{id:"六-创建脚本"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#六-创建脚本"}},[s._v("#")]),s._v(" 六 创建脚本")]),s._v(" "),e("p",[s._v("为了不写一长串的用户信息，可以把他们定义成脚本的方式")]),s._v(" "),e("p",[s._v("admin-openrc")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("export OS_PROJECT_DOMAIN_NAME=Default\nexport OS_USER_DOMAIN_NAME=Default\nexport OS_PROJECT_NAME=admin\nexport OS_USERNAME=admin\nexport OS_PASSWORD=123\nexport OS_AUTH_URL=http://192.168.31.57:35357/v3\nexport OS_IDENTITY_API_VERSION=3\nexport OS_IMAGE_API_VERSION=2\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("p",[s._v("demo-openrc")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("export OS_PROJECT_DOMAIN_NAME=Default\nexport OS_USER_DOMAIN_NAME=Default\nexport OS_PROJECT_NAME=demo\nexport OS_USERNAME=demo\nexport OS_PASSWORD=123\nexport OS_AUTH_URL=http://192.168.31.57:35357/v3\nexport OS_IDENTITY_API_VERSION=3\nexport OS_IMAGE_API_VERSION=2\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("p",[s._v("针对不同的业务应该有不同的用户信息，也都应该定义成脚本形式，方便管理")]),s._v(" "),e("p",[s._v("我们的申请token操作简化成")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("source admin-openrc\nopenstack token issue\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/zmj0920/image_store/blog/1036857-20170110231651666-253121646.png",alt:""}})]),s._v(" "),e("h2",{attrs:{id:"七-keystone使用套路总结"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#七-keystone使用套路总结"}},[s._v("#")]),s._v(" 七 keystone使用套路总结")]),s._v(" "),e("p",[s._v("（1）user归属于一个或多个Project，并且在每个项目中充当一个角色。所以我们需要创建Project，创建User，创建Role，并将User和Project、Role关联起来；")]),s._v(" "),e("p",[s._v("View Code")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('创建域，租户，用户，角色，把四个元素关联到一起\n建立一个公共的域名：\nopenstack domain create --description "Default Domain" default\n\n管理员：admin\nopenstack project create --domain default \\\n  --description "Admin Project" admin\n\nopenstack user create --domain default \\\n  --password-prompt admin\n\nopenstack role create admin\n\nopenstack role add --project admin --user admin admin\n\n普通用户：demo\nopenstack project create --domain default \\\n  --description "Demo Project" demo\n\nopenstack user create --domain default \\\n  --password-prompt demo\n\nopenstack role create user\n\nopenstack role add --project demo --user demo user\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br")])]),e("p",[s._v("（2）Keystone本质是提供Identity服务的，所以它的实现或者提供的机制也是基于用户来设计的。为了提供服务目录，配置Keystone的时候创建了一个特殊的ServiceProject，为每个服务创建对应的用户(Nova, Swift, cinder...)，并且都归属于ServiceProject。然后配置、设置相应的Endpoint。")]),s._v(" "),e("p",[s._v("View Code")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('为后续的服务创建统一租户service，所有的服务公用一个租户service\nopenstack project create --domain default \\\n  --description "Service Project" service\n\n\n建立服务实体service\nopenstack service create --name glance \\\n  --description "OpenStack Image" image\n\n建端点endpoint\nopenstack endpoint create --region RegionOne \\\n  image public http://controller01:9292\n\n\nopenstack endpoint create --region RegionOne \\\n  image internal http://controller01:9292\n\nopenstack endpoint create --region RegionOne \\\n  image admin http://controller01:9292\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br")])])])}),[],!1,null,null,null);e.default=t.exports}}]);